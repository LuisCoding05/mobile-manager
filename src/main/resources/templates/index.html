<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scrcpy Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="" crossorigin="anonymous">
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-3">Scrcpy Manager</h1>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Cómo conectar un dispositivo</h5>
          <p class="card-text"> Conecta el dispositivo por USB y habilita depuración USB en el dispositivo. (Si es el móvil de Adrián y el portatil restaurado, ya está hecho)
          Si se desea, para comprobar, en la máquina donde corre la app ejecuta <code>adb devices</code> y verás un listado de dispositivos conectados.</p>
          <p class="mb-0">Al pulsar <em>Conectar</em> en una tarjeta, la aplicación lanzará <code>scrcpy -s &lt;deviceId&gt;</code> en la carpeta configurada para scrcpy.</p>
        </div>
      </div>

      <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

      <div class="mb-3 d-flex align-items-center gap-2">
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refrescar</button>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="autoRefresh" />
          <label class="form-check-label" for="autoRefresh">Auto-refrescar cada 5s</label>
        </div>
      </div>

      <div id="deviceContainer" th:fragment="deviceList">
        <div class="row">
          <div th:if="${devices.size()}==0" class="col-12">
            <div class="alert alert-info">No hay dispositivos conectados.</div>
          </div>
          <div class="col-md-4 mb-3" th:each="dev : ${devices}">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title" th:text="${dev.id}"></h5>
                <p class="card-text">Estado: <span th:text="${dev.status}"></span></p>
                <div class="mt-auto d-flex gap-2">
                  <form th:if="${activeDeviceIds.contains(dev.id)}" th:action="@{'/disconnect/' + ${dev.id}}" method="post" style="display:inline-block;">
                    <button type="submit" class="btn btn-warning">Desconectar</button>
                  </form>
                  <form th:if="${!activeDeviceIds.contains(dev.id)}" th:action="@{'/connect/' + ${dev.id}}" method="post" style="display:inline-block;">
                    <button type="submit" class="btn btn-primary">Conectar</button>
                  </form>
                  <button type="button" class="btn btn-outline-secondary btn-sm" th:attr="data-deviceid=${dev.id}" onclick="showLogs(this.dataset.deviceid)">Logs</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Modal -->
      <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Logs</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <pre id="logsContent" style="white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        const refreshBtn = document.getElementById('refreshBtn');
        const autoRefresh = document.getElementById('autoRefresh');
        const deviceContainer = document.getElementById('deviceContainer');

        async function fetchDevices() {
          try {
            const res = await fetch('/devices');
            if (res.ok) {
              const html = await res.text();
              deviceContainer.outerHTML = html;
            }
          } catch (e) {
            console.error('Error fetching devices', e);
          }
        }

        refreshBtn.addEventListener('click', () => fetchDevices());

        let intervalId = null;
        autoRefresh.addEventListener('change', (e) => {
          if (e.target.checked) {
            intervalId = setInterval(fetchDevices, 5000);
          } else if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
          }
        });

        async function showLogs(deviceId) {
          try {
            const res = await fetch('/logs/' + encodeURIComponent(deviceId));
            const text = await res.text();
            document.getElementById('logsContent').textContent = text;
            // show modal using bootstrap
            const modalEl = document.getElementById('logsModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
          } catch (e) {
            console.error('Error getting logs', e);
            alert('Error obteniendo logs: ' + e.message);
          }
        }
      </script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="" crossorigin="anonymous"></script>
    </div>
  </body>
</html>
